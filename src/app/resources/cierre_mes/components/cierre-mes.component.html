<mat-expansion-panel class="shadow-none border-b rounded-none dark:bg-transparent z-20" [expanded]="panelOpenState"
    (opened)="panelOpenState = true" (closed)="panelOpenState = false">

    <mat-expansion-panel-header class="px-4 sm:px-6">
        <mat-panel-title class="flex items-center space-x-3">
            <mat-icon [svgIcon]="'heroicons_outline:magnifying-glass'"></mat-icon>
            <span class="font-semibold">{{ 'cierre_mes_busqueda' | translate:i18nName }}</span>
        </mat-panel-title>
        <mat-panel-description class="flex items-center justify-end">
        </mat-panel-description>
    </mat-expansion-panel-header>

    <form [formGroup]="cierreForm" (ngSubmit)="vistaPrevia()" class="w-full">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 pb-4">
            <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full">
                <mat-label>{{ 'cierre_mes_mes' | translate:i18nName }}</mat-label>
                <mat-select formControlName="mes">
                    <mat-option *ngFor="let mes of meses" [value]="mes.value">
                        {{ mes.viewValue }}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full">
                <mat-label>{{ 'cierre_mes_anio' | translate:i18nName }}</mat-label>
                <input matInput type="number" formControlName="anio" min="2001" [max]="currentYear">
            </mat-form-field>
        </div>
        <button type="submit" hidden></button>
    </form>

    <mat-action-row class="p-4 sm:px-6">
        <div class="flex items-center justify-end w-full space-x-2">

            <button mat-stroked-button type="button" (click)="limpiarFiltros()"
                [matTooltip]="'cierre_mes_limpiar' | translate:i18nName">
                <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
                <span class="ml-2 hidden sm:inline">{{ 'cierre_mes_limpiar' | translate:i18nName }}</span>
            </button>

            <button mat-flat-button color="accent" type="button" (click)="vistaPrevia()"
                [disabled]="cierreForm.invalid || loading"
                [matTooltip]="'cierre_mes_vista_previa' | translate:i18nName">

                <mat-progress-spinner *ngIf="loading" [diameter]="20" mode="indeterminate"></mat-progress-spinner>
                <mat-icon *ngIf="!loading" class="icon-size-5"
                    [svgIcon]="'heroicons_outline:magnifying-glass'"></mat-icon>

                <span class="ml-2 hidden sm:inline" *ngIf="!loading">
                    {{ 'cierre_mes_vista_previa' | translate:i18nName }}
                </span>
            </button>

        </div>
    </mat-action-row>

    <mat-progress-bar *ngIf="saving" mode="indeterminate"
        class="absolute bottom-0 left-0 w-full z-30"></mat-progress-bar>
</mat-expansion-panel>

<div class="flex flex-col flex-auto min-w-0 w-full h-full bg-gray-50 dark:bg-gray-900">
    <div class="flex-auto relative overflow-hidden h-full dark:bg-transparent flex flex-col">

        <div *ngIf="dataSource.data.length === 0"
            class="flex-auto flex flex-col items-center h-full p-6 py-10 text-center">
            <mat-icon class="icon-size-16 text-gray-300 mb-4" svgIcon="heroicons_outline:circle-stack"></mat-icon>
            <div class="text-2xl font-bold text-gray-700 dark:text-gray-200">{{ 'cierre_mes_sin_resultados' |
                translate:i18nName }}</div>
            <div class="text-secondary mt-1 max-w-sm">{{ 'cierre_mes_sin_resultados_descripcion' | translate:i18nName }}
            </div>
        </div>

        <div *ngIf="dataSource.data.length > 0"
            class="flex-auto overflow-auto container-table pb-20 dark:bg-transparent">
            <table mat-table [dataSource]="dataSource" multiTemplateDataRows class="bg-transparent w-full">

                <ng-container matColumnDef="{{column}}" *ngFor="let column of columnsToDisplay">
                    <th mat-header-cell *matHeaderCellDef class="text-sm">
                        {{ ('cierre_mes_' + column.toLowerCase()) | translate:i18nName }}
                    </th>
                    <td mat-cell *matCellDef="let element">
                        {{element[column]}}
                    </td>
                </ng-container>

                <ng-container matColumnDef="expand">
                    <th mat-header-cell *matHeaderCellDef class="w-10 px-2 border-b">
                    </th>
                    <td mat-cell *matCellDef="let element" class="px-2 border-b text-center w-10">
                        <button mat-icon-button
                            (click)="(expandedElement = expandedElement === element ? null : element); $event.stopPropagation()">
                            <mat-icon
                                [svgIcon]="expandedElement === element ? 'heroicons_solid:chevron-up' : 'heroicons_solid:chevron-down'"></mat-icon>
                        </button>
                    </td>
                </ng-container>

                <ng-container matColumnDef="expandedDetail">
                    <td mat-cell *matCellDef="let element" [attr.colspan]="columnsToDisplayWithExpand.length"
                        class="p-0 border-0">
                        <div class="element-detail overflow-hidden flex flex-col w-full bg-gray-50/50 dark:bg-gray-900 border-l-4 border-l-primary-500"
                            [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">

                            <div class="p-4 grid gap-6">
                                <div
                                    class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 text-sm text-secondary border-b pb-4 border-gray-200 dark:border-gray-700">
                                    <div class="flex flex-col"><span
                                            class="text-xs font-bold uppercase tracking-wider text-secondary/60">{{
                                            'cierre_mes_cantmb' | translate:i18nName }}</span> <span
                                            class="font-medium text-default">{{element.cantMB}}</span></div>
                                    <div class="flex flex-col"><span
                                            class="text-xs font-bold uppercase tracking-wider text-secondary/60">{{
                                            'cierre_mes_cantb' | translate:i18nName }}</span> <span
                                            class="font-medium text-default">{{element.cantB}}</span></div>
                                    <div class="flex flex-col"><span
                                            class="text-xs font-bold uppercase tracking-wider text-secondary/60">{{
                                            'cierre_mes_cantr' | translate:i18nName }}</span> <span
                                            class="font-medium text-default">{{element.cantR}}</span></div>
                                    <div class="flex flex-col"><span
                                            class="text-xs font-bold uppercase tracking-wider text-secondary/60">{{
                                            'cierre_mes_cantm' | translate:i18nName }}</span> <span
                                            class="font-medium text-default">{{element.cantM}}</span></div>
                                    <div class="flex flex-col"><span
                                            class="text-xs font-bold uppercase tracking-wider text-secondary/60">{{
                                            'cierre_mes_cantsv' | translate:i18nName }}</span> <span
                                            class="font-medium text-default">{{element.cantSV}}</span></div>
                                    <div class="flex flex-col"><span
                                            class="text-xs font-bold uppercase tracking-wider text-secondary/60">{{
                                            'cierre_mes_porcentajevaloracion' | translate:i18nName }}</span> <span
                                            class="font-medium text-default">{{element.porcentajeValoracion}}</span>
                                    </div>
                                    <div class="flex flex-col"><span
                                            class="text-xs font-bold uppercase tracking-wider text-secondary/60">{{
                                            'cierre_mes_objetivoactividades' | translate:i18nName }}</span> <span
                                            class="font-medium text-default">{{element.objetivoActividades}}</span>
                                    </div>
                                    <div class="flex flex-col"><span
                                            class="text-xs font-bold uppercase tracking-wider text-secondary/60">{{
                                            'cierre_mes_cantidadactividades' | translate:i18nName }}</span> <span
                                            class="font-medium text-default">{{element.cantidadActividades}}</span>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-center">
                                    <mat-form-field appearance="outline" subscriptSizing="dynamic"
                                        class="w-full bg-white dark:bg-gray-800">
                                        <mat-label>{{ 'cierre_mes_viaticos' | translate:i18nName }}</mat-label>
                                        <input matInput type="number" [(ngModel)]="element.viaticos" min="0"
                                            step="0.01">
                                    </mat-form-field>

                                    <mat-form-field appearance="outline" subscriptSizing="dynamic"
                                        class="w-full bg-white dark:bg-gray-800">
                                        <mat-label>{{ 'cierre_mes_adelanto' | translate:i18nName }}</mat-label>
                                        <input matInput type="number" [(ngModel)]="element.adelanto" min="0"
                                            step="0.01">
                                    </mat-form-field>

                                    <mat-form-field appearance="outline" subscriptSizing="dynamic"
                                        class="w-full bg-white dark:bg-gray-800">
                                        <mat-label>{{ 'cierre_mes_prestamo' | translate:i18nName }}</mat-label>
                                        <input matInput type="number" [(ngModel)]="element.prestamo" min="0"
                                            step="0.01">
                                    </mat-form-field>

                                    <mat-form-field appearance="outline" subscriptSizing="dynamic"
                                        class="w-full bg-white dark:bg-gray-800">
                                        <mat-label>{{ 'cierre_mes_gratificacionesaumentos' | translate:i18nName
                                            }}</mat-label>
                                        <input matInput type="text" [(ngModel)]="element.gratificacionesAumentos"
                                            maxlength="200" />
                                    </mat-form-field>

                                    <div class="flex justify-center p-2 rounded h-10 items-center">
                                        <mat-slide-toggle [(ngModel)]="element.premioAsistencia" color="primary">
                                            {{ 'cierre_mes_premioasistencia' | translate:i18nName }}
                                        </mat-slide-toggle>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="columnsToDisplayWithExpand; sticky: true"></tr>
                <tr mat-row *matRowDef="let element; columns: columnsToDisplayWithExpand;"
                    class="element-row cursor-pointer bg-white dark:bg-gray-900 hover:bg-primary-50 dark:hover:bg-gray-800/50 transition-colors"
                    [class.bg-primary-50]="expandedElement === element"
                    [class.dark:bg-gray-800]="expandedElement === element"
                    (click)="expandedElement = expandedElement === element ? null : element">
                </tr>
                <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row h-0"></tr>
            </table>
        </div>
    </div>

    <mat-paginator *ngIf="dataSource.data.length > 0" class="border-t bottom-0 fixed print:hidden w-full z-30"
        [pageSize]="10" [pageSizeOptions]="[10, 25, 50, 100]" showFirstLastButtons>
    </mat-paginator>
</div>