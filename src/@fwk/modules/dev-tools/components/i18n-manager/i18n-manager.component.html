<div *ngIf="isLoading || isSaving"
    class="bg-white dark:bg-gray-900 flex flex-col inset-0 items-center justify-center ng-star-inserted relative top-0 z-10">
    <mat-progress-bar mode="indeterminate" class="w-full"></mat-progress-bar>
    <p class="mt-4 font-medium text-secondary">{{ (isSaving ? 'dev_tools_i18n_saving' : 'dev_tools_i18n_loading') |
        translate }}</p>
</div>

<div class="bg-white dark:bg-gray-900 relative h-full flex flex-col">
    <div [formGroup]="mainForm" class="flex-auto" *ngIf="!isLoading">
        <div class="p-6 border-b flex justify-between bg-gray-100 dark:bg-gray-800 flex-shrink-0 sticky top-0 bg-card z-10 pt-6 pb-2 mb-6">
            <mat-form-field class="w-full sm:w-1/3" appearance="outline">
                <mat-label>{{ 'dev_tools_i18n_search_placeholder' | translate }}</mat-label>
                <input matInput [formControl]="searchControl" autocomplete="off">
                <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>
            <div class="flex items-start justify-end ng-star-inserted sm:w-1/2 w-full" *ngIf="mainForm.dirty && !isLoading">
                <button mat-stroked-button (click)="revertChanges()" class="mr-2">{{ 'dev_tools_discard_button' | translate }}</button>
                <button mat-flat-button color="accent" (click)="saveChanges()" [disabled]="isSaving">{{ 'dev_tools_save_changes_button' | translate }}</button>
            </div>
        </div>

        <mat-accordion multi>
            <mat-expansion-panel class="border mx-6" *ngIf="!searchControl.value || panelOpenState[i]" formGroupName="meta"
                [hidden]="metaPanelState.hidden" [expanded]="metaPanelState.expanded"
                (opened)="metaPanelState.expanded = true" (closed)="metaPanelState.expanded = false">
                <mat-expansion-panel-header>
                    <mat-panel-title class="font-medium text-lg">{{ 'dev_tools_i18n_site_texts_title' | translate
                        }}</mat-panel-title>
                </mat-expansion-panel-header>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4">
                    <mat-form-field appearance="outline" subscriptSizing="dynamic">
                        <mat-label>{{ 'dev_tools_i18n_tab_title' | translate }}</mat-label>
                        <input matInput formControlName="title">
                    </mat-form-field>
                    <mat-form-field appearance="outline" subscriptSizing="dynamic">
                        <mat-label>{{ 'dev_tools_i18n_meta_description' | translate }}</mat-label>
                        <textarea matInput formControlName="description" cdkTextareaAutosize></textarea>
                    </mat-form-field>
                </div>
            </mat-expansion-panel>

            <ng-container formArrayName="categories">
                <ng-container *ngFor="let category of categoriesArray.controls; let i = index">
                    <mat-expansion-panel class="border mx-6" *ngIf="!searchControl.value || panelOpenState[i]"
                        [formGroupName]="i" [expanded]="panelOpenState[i]" (opened)="panelOpenState[i] = true"
                        (closed)="panelOpenState[i] = false">

                        <mat-expansion-panel-header>
                            <mat-panel-title class="font-medium text-lg">
                                {{ category.get('name').value | titlecase }}
                            </mat-panel-title>
                        </mat-expansion-panel-header>

                        <div class="overflow-auto" [formArrayName]="'keys'">
                            <table mat-table [dataSource]="dataSources[i]" class="w-full">
                                <ng-container matColumnDef="key">
                                    <th mat-header-cell *matHeaderCellDef class="w-1/3">{{ 'dev_tools_i18n_key_column' |
                                        translate }}</th>
                                    <td mat-cell *matCellDef="let keyControl" class="font-mono text-sm pr-4">{{
                                        keyControl.get('key').value }}</td>
                                </ng-container>

                                <ng-container matColumnDef="value">
                                    <th mat-header-cell *matHeaderCellDef>{{ 'dev_tools_i18n_value_column' | translate
                                        }}</th>
                                    <td mat-cell *matCellDef="let keyControl">
                                        <mat-form-field class="w-full" appearance="outline" subscriptSizing="dynamic">
                                            <input matInput [formControl]="keyControl.get('value')">
                                        </mat-form-field>
                                    </td>
                                </ng-container>

                                <tr mat-header-row *matHeaderRowDef="['key', 'value']"></tr>
                                <tr mat-row *matRowDef="let row; columns: ['key', 'value'];" [formGroup]="row"></tr>

                                <tr class="mat-row" *matNoDataRow>
                                    <td class="mat-cell text-center text-secondary py-4" colspan="2"
                                        *ngIf="searchControl.value">
                                        {{ 'dev_tools_i18n_no_matches' | translate }}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </mat-expansion-panel>
                </ng-container>
            </ng-container>
        </mat-accordion>
    </div>
</div>